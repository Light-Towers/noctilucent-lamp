# 微信支付开发文档

## 一、微信官方文档

> **微信支付API稳定版本区别: V3与V2的主要区别**
> 1. 遵循统一的REST的设计风格
> 2. 使用JSON作为数据交互的格式，不再使用XML
> 3. 使用基于非对称密钥的SHA256-RSA的数字签名算法，不再使用MD5或HMAC-SHA256
> 4. 签名需要使用商户API证书进行签名。具体可参考[什么是商户API证书如何获取？](https://pay.weixin.qq.com/doc/v3/merchant/4013053053)
> 5. 验签支持2种方式：
>    - **微信支付公钥模式（推荐使用）**：商户在验证微信支付API应答和回调通知的签名时需要用到微信支付公钥，且商户可以按需更新微信支付公钥。
>    - 平台证书模式：商户在验证微信支付API应答和回调通知的签名时需要用到平台证书，平台证书的有效期为5年，商户需每5年更新一次，对系统实现要求较高，推荐使用微信支付公钥模式。
> 6. 使用AES-256-GCM，对回调中的关键信息进行加密保护

### 1. 支付方式说明

#### 1.1 普通支付方式

| 支付方式 | 使用场景 | 官方文档 |
|---------|---------|---------|
| JSAPI支付 | 微信客户端内部浏览器 | [JSAPI支付文档](https://pay.weixin.qq.com/doc/v3/merchant/4012062524) |
| APP支付 | APP | [APP支付](https://pay.weixin.qq.com/doc/v3/merchant/4013070158) |
| H5支付 | 手机浏览器网页（非微信客户端内部浏览器） | [H5支付文档](https://pay.weixin.qq.com/doc/v3/merchant/4012791832) |
| Native支付 | PC端网页浏览器 | [Native支付](https://pay.weixin.qq.com/doc/v3/merchant/4012791874) |
| 小程序支付 | 微信小程序 | [小程序支付](https://pay.weixin.qq.com/doc/v3/merchant/4012791894) |

#### 1.2 特殊支付方式

| 支付方式 | 说明 | 官方文档 |
|---------|------|---------|
| 合单支付 | 将多个商户的订单（普通商户模式支持2-10笔订单）合并为一个订单进行支付的能力 | [合单支付](https://pay.weixin.qq.com/doc/v3/merchant/4012077203) |
| 付款码支付 | 刷卡支付方式 | [付款码支付(V2)](https://pay.weixin.qq.com/doc/v2/merchant/4011936234) |
| 刷脸支付 | 基于人脸识别的支付方式 | [刷脸支付平台](https://pay.weixin.qq.com/wiki/doc/wxfacepay/product/) |

### 2. JSAPI支付实现指南

JSAPI支付流程配置：

![JSAPI支付流程](https://gtimg.wechatpay.cn/resource/xres/mmpaydoc/static/img/9c5784caea8475b67cfe55141aba2d4f.png)

![img](https://gtimg.wechatpay.cn/resource/xres/mmpaydoc/static/img/713850c0595731717d544152b686b5ab.png)

#### 2.1 支付流程

微信JSAPI支付的主要流程如下：

1. 商户下单：商户后端调用[JSAPI/小程序下单](https://pay.weixin.qq.com/doc/v3/merchant/4012791856)接口获取预支付ID（prepay_id）

   1. `openid`：用户在商户下单的appid下唯一标识，获取方式详见[参数说明](https://pay.weixin.qq.com/doc/v3/merchant/4012068676)。
   2. `time_expire`：支付结束时间。若传递该参数，则用户只能在订单设置的支付结束时间`time_expire`之前进行支付，超过支付结束时间后，用户支付将收到："订单已超过商户设置的最晚支付成功时间，请重新发起支付"的提示，商户需对订单进行关单处理。若不传该参数，默认订单支付有效期为7天，用户可在7天内进行支付，超出7天，订单将被关闭。
   3. `prepay_id`：预支付交易会话标识。调起支付时需要使用的参数，`prepay_id`有效期为2小时，超过2小时，**商户需要使用原下单参数重新请求下单接口**，获取新的`prepay_id`。

2. 商户调起支付：微信客户端前端页面调用[WeixinJSBridge](https://pay.weixin.qq.com/doc/v3/merchant/4012791857)对象方法调起微信支付界面

   1. 商户调起支付前，确保已在[商户平台](https://pay.weixin.qq.com/)配置好JSAPI支付授权目录（只有[配置了JSAPI支付授权目录](https://pay.weixin.qq.com/doc/v3/merchant/4013287088)的网页才能调起支付）
   2. 然后通过调用微信浏览器内置对象方法来调起微信收银台，具体请参考[JSAPI调起支付](https://pay.weixin.qq.com/doc/v3/merchant/4012791857)

3. 用户支付：用户在完成支付/取消支付，返回商户前端页面后，微信浏览器内置对象方法会收到回调，此时商户需要调[查询订单API](https://pay.weixin.qq.com/doc/v3/merchant/4012791859)接口确认订单状态，并根据订单状态向用户展示支付结果。

   同时，如果用户支付成功，微信支付系统会向商户发送[支付成功回调](https://pay.weixin.qq.com/doc/v3/merchant/4012791861)。未收到回调时，商户也可调用[查询订单API](https://pay.weixin.qq.com/doc/v3/merchant/4012791859)接口确认订单状态。具体实现方案商户可以参考[支付回调和查单实现指引](https://pay.weixin.qq.com/doc/v3/merchant/4012075249)。


#### 2.2 注意事项

1. **签名算法**：微信支付V3版本使用SHA256 with RSA算法进行签名
2. **证书管理**：需要正确配置商户私钥和微信支付平台证书
3. **回调验证**：必须验证微信支付回调通知的签名，确保安全性
4. **HTTPS要求**：支付接口必须在HTTPS环境下使用
5. **域名配置**：需要在微信商户平台配置JSAPI支付授权目录

#### 2.3 安全建议

1. 所有支付相关接口都应进行身份验证
2. 验证支付金额与订单金额是否一致
3. 防止重复通知处理
4. 日志记录所有支付操作
5. 定期更新商户证书

#### 2.4 错误处理

常见的错误及处理方式：

1. 签名验证失败：检查证书和签名算法是否正确
2. prepay_id过期：重新调用下单接口获取
3. 支付取消：引导用户重新支付
4. 网络异常：提示用户检查网络并重试

#### 2.5 参考文档

- [微信支付官方文档 - JSAPI支付](https://pay.weixin.qq.com/doc/v3/merchant/4012791870)

## 二、第三方工具 WxJava

### 1. 简介

[binarywang/WxJava](https://github.com/binarywang/WxJava) 是一个开源、非官方、功能全面的微信 Java 开发工具包。它封装了微信开放平台、公众号、小程序、企业微信、视频号、微信支付等各个模块的 API 接口，大大简化了微信相关功能的开发工作。

### 2. 主要模块

- 微信小程序：`weixin-java-miniapp`
- 微信支付：`weixin-java-pay`
- 微信开放平台：`weixin-java-open`
- 微信公众号：`weixin-java-mp`
- 企业微信：`weixin-java-cp`
- 微信视频号/微信小店：`weixin-java-channel`

### 3. 优势特点

1. **全面支持**：支持微信所有模块的开发，包括公众号、小程序、支付、企业微信等
2. **易于集成**：提供 Spring Boot Starter，可快速集成到 Spring Boot 项目中
3. **自动更新**：及时跟进微信官方 API 更新，保持与最新版本同步
4. **文档完善**：提供详细的使用文档和示例代码
5. **社区活跃**：拥有大量使用者和贡献者，问题解决迅速
6. **稳定可靠**：经过多年发展和众多项目验证，稳定性高

### 4. 集成方式

#### 4.1 Maven 依赖

在项目 pom.xml 中添加相关依赖：

```xml
<!-- 微信支付模块 -->
<dependency>
    <groupId>com.github.binarywang</groupId>
    <artifactId>weixin-java-pay</artifactId>
    <version>4.7.0</version>
</dependency>

<!-- 微信公众号模块 -->
<dependency>
    <groupId>com.github.binarywang</groupId>
    <artifactId>weixin-java-mp</artifactId>
    <version>4.7.0</version>
</dependency>

<!-- 微信小程序模块 -->
<dependency>
    <groupId>com.github.binarywang</groupId>
    <artifactId>weixin-java-miniapp</artifactId>
    <version>4.7.0</version>
</dependency>
```

#### 4.2 Spring Boot 集成

使用 Spring Boot Starter 可以更方便地集成：

```xml
<dependency>
    <groupId>com.github.binarywang</groupId>
    <artifactId>wx-java-pay-spring-boot-starter</artifactId>
    <version>4.7.0</version>
</dependency>
```

### 5. 微信支付集成示例

使用 WxJava 可以大大简化微信支付的集成过程：

#### 5.1 配置文件

在 application.yml 中配置微信支付参数：

```yaml
wx:
  pay:
    appId: your-app-id #微信公众号ID或者小程序等的appid (V3商户模式需要)
    mchId: your-mch-id #微信支付商户号 (V3商户模式需要)
    mchKey: your-mch-key #微信支付商户密钥
    subAppId: #服务商模式下的子商户公众账号ID
    subMchId: #服务商模式下的子商户号
    keyPath: classpath:cert/apiclient_cert.p12     # p12证书的位置，可以指定绝对路径，也可以指定类路径（以classpath:开头）
    apiV3Key: # apiV3 秘钥值 (V3商户模式需要)
    certSerialNo: # apiV3 证书序列号值 (V3商户模式需要)
    privateCertPath: # apiclient_cert.pem证书文件的绝对路径或者以classpath:开头的类路径. (V3商户模式需要)
    privateKeyPath: # apiclient_key.pem证书文件的绝对路径或者以classpath:开头的类路径. (V3商户模式需要)
    publicKeyPath: # 微信支付公钥，pub_key.pem证书文件的绝对路径或者以classpath:开头的类路径. (V3商户模式需要)
    publicKeyId: # 微信支付公钥ID (V3商户模式需要)
    notifyUrl: https://your-domain.com/pay/notify
```

#### 5.2 配置类

```java
package com.github.binarywang.demo.wx.pay.config;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * wxpay pay properties.
 *
 * @author Binary Wang
 */
@Data
@ConfigurationProperties(prefix = "wx.pay")
public class WxPayProperties {
  /**
   * 设置微信公众号或者小程序等的appid
   * (V3商户模式需要)
   */
  private String appId;

  /**
   * 微信支付商户号
   * (V3商户模式需要)
   */
  private String mchId;

  /**
   * 微信支付商户密钥
   */
  private String mchKey;

  /**
   * 服务商模式下的子商户公众账号ID，普通模式请不要配置，请在配置文件中将对应项删除
   */
  private String subAppId;

  /**
   * 服务商模式下的子商户号，普通模式请不要配置，最好是请在配置文件中将对应项删除
   */
  private String subMchId;

  /**
   * apiclient_cert.p12文件的绝对路径，或者如果放在项目中，请以classpath:开头指定
   */
  private String keyPath;

  /**
   * apiV3 秘钥值
   * (V3商户模式需要)
   */
  private String apiV3Key;

  /**
   * apiV3 证书序列号值
   * (V3商户模式需要)
   */
  private String certSerialNo;

  /**
   * apiclient_cert.pem证书文件的绝对路径或者以classpath:开头的类路径.
   * (V3商户模式需要，这里用的是文件路径，可以用其它base64编码或字节数组参数替代)
   */
  private String privateCertPath;

  /**
   * apiclient_key.pem证书文件的绝对路径或者以classpath:开头的类路径.
   * (V3商户模式需要，这里用的是文件路径，可以用其它base64编码或字节数组参数替代)
   */
  private String privateKeyPath;

  /**
   * 微信支付公钥，pub_key.pem证书文件的绝对路径或者以classpath:开头的类路径.
   * (V3商户模式需要，这里用的是文件路径，可以用其它base64编码或字节数组参数替代，2024.08后的新商户验签需要用此公钥)
   */
  private String publicKeyPath;

  /**
   * 微信支付公钥ID
   * (V3商户模式需要，2024.08后的新商户验签需要用此公钥ID)
   */
  private String publicKeyId;

}
```

#### 5.3 微信支付接口类

```java
package com.github.binarywang.demo.wx.pay.controller;

import com.github.binarywang.wxpay.bean.notify.SignatureHeader;
import com.github.binarywang.wxpay.bean.notify.WxPayNotifyV3Response;
import com.github.binarywang.wxpay.bean.notify.WxPayNotifyV3Result;
import com.github.binarywang.wxpay.bean.notify.WxPayNotifyV3Result.DecryptNotifyResult;
import com.github.binarywang.wxpay.bean.notify.WxPayRefundNotifyV3Result;
import com.github.binarywang.wxpay.bean.request.*;
import com.github.binarywang.wxpay.bean.result.WxPayOrderQueryV3Result;
import com.github.binarywang.wxpay.bean.result.WxPayRefundQueryV3Result;
import com.github.binarywang.wxpay.bean.result.WxPayRefundV3Result;
import com.github.binarywang.wxpay.bean.result.WxPayUnifiedOrderV3Result.AppResult;
import com.github.binarywang.wxpay.bean.result.WxPayUnifiedOrderV3Result.JsapiResult;
import com.github.binarywang.wxpay.bean.result.enums.TradeTypeEnum;
import com.github.binarywang.wxpay.constant.WxPayConstants;
import com.github.binarywang.wxpay.exception.WxPayException;
import com.github.binarywang.wxpay.service.WxPayService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.AllArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;


/**
 * @author Binary Wang
 */
@Api("微信支付V3部分接口示例")
@RestController
@RequestMapping("/pay/v3")
@AllArgsConstructor
public class WxPayV3Controller {
    private WxPayService wxService;

    /**
     * <pre>
     * 查询订单
     * 详见https://pay.weixin.qq.com/doc/v3/merchant/4012791858)
     *
     * </pre>
     *
     * @param transactionId 微信订单号
     * @param outTradeNo    商户系统内部的订单号，当没提供transactionId时需要传这个。
     */
    @ApiOperation(value = "查询订单")
    @GetMapping("/queryOrder")
    public WxPayOrderQueryV3Result queryOrder(@RequestParam(required = false) String transactionId,
                                              @RequestParam(required = false) String outTradeNo)
            throws WxPayException {
        return this.wxService.queryOrderV3(transactionId, outTradeNo);
    }

    @ApiOperation(value = "查询订单")
    @PostMapping("/queryOrder")
    public WxPayOrderQueryV3Result queryOrder(@RequestBody WxPayOrderQueryV3Request wxPayOrderQueryV3Request) throws WxPayException {
        return this.wxService.queryOrderV3(wxPayOrderQueryV3Request);
    }

    /**
     * <pre>
     * 关闭订单
     * 详见https://pay.weixin.qq.com/doc/v3/merchant/4012791860
     *
     * </pre>
     *
     * @param outTradeNo 商户系统内部的订单号
     */
    @ApiOperation(value = "关闭订单")
    @GetMapping("/closeOrder/{outTradeNo}")
    public void closeOrder(@PathVariable String outTradeNo) throws WxPayException {
        this.wxService.closeOrderV3(outTradeNo);
    }

    @ApiOperation(value = "关闭订单")
    @PostMapping("/closeOrder")
    public void closeOrder(@RequestBody WxPayOrderCloseV3Request wxPayOrderCloseV3Request) throws WxPayException {
        this.wxService.closeOrderV3(wxPayOrderCloseV3Request);
    }

    /**
     * 调用统一下单接口(JSAPI)
     * 详见：https://pay.weixin.qq.com/doc/v3/merchant/4012791856
     */
    @ApiOperation(value = "统一下单，并组装所需支付参数")
    @PostMapping("/createOrder")
    public JsapiResult createOrder(@RequestBody WxPayUnifiedOrderV3Request request) throws WxPayException {
        return this.wxService.createOrderV3(TradeTypeEnum.JSAPI, request);
    }

    /**
     * 调用统一下单接口(APP)
     */
    @ApiOperation(value = "统一下单，并组装所需支付参数")
    @PostMapping("/createOrderApp")
    public AppResult createOrderApp(@RequestBody WxPayUnifiedOrderV3Request request) throws WxPayException {
        return this.wxService.createOrderV3(TradeTypeEnum.APP, request);
    }

    /**
     * <pre>
     * 微信支付-申请退款
     * 详见 https://pay.weixin.qq.com/doc/v3/merchant/4012791862
     * </pre>
     *
     * @param request 请求对象
     * @return 退款操作结果
     */
    @ApiOperation(value = "退款")
    @PostMapping("/refund")
    public WxPayRefundV3Result refund(@RequestBody WxPayRefundV3Request request) throws WxPayException {
        return this.wxService.refundV3(request);
    }

    /**
     * <pre>
     * 微信支付-查询退款
     * 详见 https://pay.weixin.qq.com/doc/v3/merchant/4012791863
     * </pre>
     *
     * @param outRefundNo 商户退款单号
     * @return 退款信息
     */
    @ApiOperation(value = "退款查询")
    @GetMapping("/refundQuery")
    public WxPayRefundQueryV3Result refundQuery(@RequestParam("outRefundNo") String outRefundNo)
            throws WxPayException {
        return this.wxService.refundQueryV3(outRefundNo);
    }

    @ApiOperation(value = "退款查询")
    @PostMapping("/refundQuery")
    public WxPayRefundQueryV3Result refundQuery(@RequestBody WxPayRefundQueryV3Request wxPayRefundQueryV3Request) throws WxPayException {
        return this.wxService.refundQueryV3(wxPayRefundQueryV3Request);
    }

    /**
     * <pre>
     * 支付成功回调
     * 详见 https://pay.weixin.qq.com/doc/v3/merchant/4012791861
     * </pre>
     *
     * @param notifyData
     * @param request
     * @return
     * @throws WxPayException
     */
    @ApiOperation(value = "支付回调通知处理")
    @PostMapping("/notify/order")
    public ResponseEntity<String> parseOrderNotifyResult(@RequestBody String notifyData, HttpServletRequest request) {
        SignatureHeader header = getRequestHeader(request);
        try {
            WxPayNotifyV3Result res = this.wxService.parseOrderNotifyV3Result(notifyData, header);
            DecryptNotifyResult decryptRes = res.getResult();
            // TODO 根据自己业务场景需要构造返回对象
            if (WxPayConstants.WxpayTradeStatus.SUCCESS.equals(decryptRes.getTradeState())) {
                //成功返回200/204，body无需有内容
                return ResponseEntity.status(200).body("");
            } else {
                //失败返回4xx或5xx，且需要构造body信息
                return ResponseEntity.status(500).body(WxPayNotifyV3Response.fail("错误原因"));
            }
        } catch (WxPayException e) {
            //失败返回4xx或5xx，且需要构造body信息
            return ResponseEntity.status(500).body(WxPayNotifyV3Response.fail("错误原因"));
        }
    }

    /**
     * <pre>
     * 支付成功回调
     * 详见 https://pay.weixin.qq.com/doc/v3/merchant/4012791865
     * </pre>
     *
     * @param notifyData
     * @param request
     * @return
     * @throws WxPayException
     */
    @ApiOperation(value = "退款回调通知处理")
    @PostMapping("/notify/refund")
    public ResponseEntity<String> parseRefundNotifyResult(@RequestBody String notifyData, HttpServletRequest request) {
        SignatureHeader header = getRequestHeader(request);
        try {
            WxPayRefundNotifyV3Result res = this.wxService.parseRefundNotifyV3Result(notifyData, header);
            WxPayRefundNotifyV3Result.DecryptNotifyResult decryptRes = res.getResult();
            // TODO 根据自己业务场景需要构造返回对象
            if (WxPayConstants.RefundStatus.SUCCESS.equals(decryptRes.getRefundStatus())) {
                //成功返回200/204，body无需有内容
                return ResponseEntity.status(200).body("");
            } else {
                //失败返回4xx或5xx，且需要构造body信息
                return ResponseEntity.status(500).body(WxPayNotifyV3Response.fail("错误原因"));
            }
        } catch (WxPayException e) {
            //失败返回4xx或5xx，且需要构造body信息
            return ResponseEntity.status(500).body(WxPayNotifyV3Response.fail("错误原因"));
        }
    }

    /**
     * 组装请求头重的前面信息
     *
     * @param request
     * @return
     */
    private SignatureHeader getRequestHeader(HttpServletRequest request) {
        // 获取通知签名
        String signature = request.getHeader("Wechatpay-Signature");
        String nonce = request.getHeader("Wechatpay-Nonce");
        String serial = request.getHeader("Wechatpay-Serial");
        String timestamp = request.getHeader("Wechatpay-Timestamp");

        SignatureHeader signatureHeader = new SignatureHeader();
        signatureHeader.setSignature(signature);
        signatureHeader.setNonce(nonce);
        signatureHeader.setSerial(serial);
        signatureHeader.setTimeStamp(timestamp);
        return signatureHeader;
    }
}
```

#### 5.4 前端JavaScript实现

##### 5.4.1 微信JSAPI支付前端代码 (wechat-jsapi-payment.js)

```java
/**
 * 调用微信JSAPI支付
 * @param {Object} payParams - 支付参数，由后端生成
 */
function callWeChatPay(payParams) {
    // onBridgeReady
    function onBridgeReady() {
        WeixinJSBridge.invoke('getBrandWCPayRequest', {
            "appId": payParams.appId,     //公众号ID，由商户传入
            "timeStamp": payParams.timeStamp, //时间戳，自1970年以来的秒数
            "nonceStr": payParams.nonceStr, //随机串; e61463f8efa94090b1f366cccfbbb444
            "package": payParams.package,	// prepay_id=wx21201855730335ac86f8c43d1889123400
            "signType": payParams.signType, //微信签名方式; RSA
            "paySign": payParams.paySign //微信签名
        }, function(res) {
            if (res.err_msg == "get_brand_wcpay_request:ok") {
                // 使用以上方式判断前端返回,微信团队郑重提示：
                //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠，商户需进一步调用后端查单确认支付结果。
                alert("支付成功");
                // 支付成功处理逻辑，例如跳转到成功页面
                window.location.href = "/payment-success";
            } else if (res.err_msg == "get_brand_wcpay_request:cancel") {
                alert("支付取消");
                // 用户取消支付处理逻辑
            } else {
                alert("支付失败");
                // 支付失败处理逻辑
                window.location.href = "/payment-failed";
            }
        });
    }

    // 检查是否在微信浏览器中
    if (typeof WeixinJSBridge === "undefined") {
        if (document.addEventListener) {
            document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
        } else if (document.attachEvent) {
            document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
            document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
        }
    } else {
        onBridgeReady();
    }
}

/**
 * 发起支付请求
 * @param {Object} orderInfo - 订单信息
 */
function requestPayment(orderInfo) {
    // 向后端发送支付请求
    fetch('/api/wechat/pay/jsapi', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            openid: orderInfo.openid,
            out_trade_no: orderInfo.out_trade_no,
            amount: orderInfo.amount,
            description: orderInfo.description,
            time_expire: orderInfo.time_expire
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 0) {
            // 调用微信支付
            callWeChatPay(data.data);
        } else {
            alert('支付发起失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('支付请求异常');
    });
}

// 使用示例
/*
const orderInfo = {
    openid: "oUpF8uMuAJO_M2pxb1Q9zNjWeS6o",
    out_trade_no: "20150806125346",
    amount: 100,  // 单位为分
    description: "商品描述",
    time_expire: "2025-01-01T12:00:00+08:00"
};

requestPayment(orderInfo);
*/
```

#### 

### 6. 使用建议

1. **新项目推荐**：对于新项目，强烈推荐使用 WxJava，可以显著提高开发效率
2. **老项目迁移**：老项目可以根据实际情况逐步迁移到 WxJava
3. **学习参考**：即使不直接使用，也可以参考其设计思路和实现方式
4. **问题排查**：遇到微信支付相关问题时，可以参考其源码进行排查

### 7. 相关资源

- [GitHub 项目地址](https://github.com/binarywang/WxJava)
- [开发文档 Wiki](https://github.com/binarywang/WxJava/wiki)
- [示例项目](https://github.com/binarywang/weixin-java-pay-demo)



## 三、当前现有代码的实现逻辑

### 1. 订单支付流程

#### 1.1 创建订单
调用服务方法创建订单:
```
com.mingyang.service.impl.HomeOrderServiceImpl#contractorOrder
```

#### 1.2 调用支付接口
调用支付接口并返回支付二维码(codeUrl):
```
com.mingyang.controller.PayController#unifiedOrder
com.mingyang.service.impl.PayServiceImpl#wxUnifiedOrder
```

#### 1.3 支付回调处理
支付成功后的回调处理:
```
com.mingyang.service.impl.HomeOrderServiceImpl#buildOrderPayCallback
```

### 2. 微信支付配置信息

#### 2.1 微信支付基本配置
配置类：`SysOrgConfigApi`；配置表：`sys_org_config_api`

| 配置项 | 配置名称 | 说明 |
|--------|---------|------|
| wxPayAppId | 微信支付应用ID | 微信支付分配的应用ID |
| wxPayMchId | 微信支付商户ID | 微信支付分配的商户ID |
| wxPayApiV2Key | 微信支付API v2密钥 | API v2版本的密钥 |
| wxPayKeyContent | 商户私钥内容 | 商户API证书私钥内容 |
| wxPayApiNotifyUrl | 支付结果通知URL | 接收微信支付异步通知地址 |
| wxPayTradeType | 交易类型 | 如: NATIVE、JSAPI等 |

> 注：JSAPI支付需要额外配置公众号信息和用户openId

#### 2.2 微信公众号配置
用于网页授权、获取用户信息等场景：

| 配置项 | 配置名称 | 说明 |
|--------|---------|------|
| wxAppid | 微信公众号AppId | 公众号唯一标识 |
| wxSecret | 微信公众号密钥 | 公众号开发者密码 |

#### 2.3 微信小程序配置
如果需要支持小程序支付：

| 配置项 | 配置名称 | 说明 |
|--------|---------|------|
| wxAppletAppid | 微信小程序AppId | 小程序唯一标识 |
| wxAppletSecret | 微信小程序密钥 | 小程序开发者密码 |

### 3. 配置获取机制

初始化支付配置信息并返回机构配置的方法:
```
com.mingyang.service.impl.PayServiceImpl#initWxPayServiceByOrgId
```

配置获取流程：
1. **优先获取机构个性化配置**
   - 从 `com.mingyang.common.org.OrgConfigService#getOrgApiConfig` 获取机构配置
2. **降级到全局配置**
   - 如果机构个性化配置不完整或不存在，则通过 `com.mingyang.common.feign.service.SysService#queryOrgConfigVoById` -> `com.mingyang.controller.SysOrgConfigApiController#getOrDefault` 获取全局配置

### 4. 配置管理平台

进入 [运营管理平台](http://192.168.100.9/web) (用户名: admin、密码: 111111)

#### 4.1 全局配置
路径：系统设置 -> 信息配置 -> 微信wechat

![全局配置界面](C:\Users\osmondy\AppData\Roaming\Typora\typora-user-images\image-20250911175340248.png)

#### 4.2 项目级配置
路径：项目管理 -> 项目配置 -> "项目配置" -> 微信wechat

![项目配置界面](C:\Users\osmondy\AppData\Roaming\Typora\typora-user-images\image-20250911180153855.png)

#### 4.3. 配置保存接口

配置保存的入口方法:
```
com.mingyang.controller.SysOrgConfigApiController#save
```



# 获取证书序列号
openssl x509 -in apiclient_cert.pem -noout -serial






WxJava V4.7 源码解读
com.github.binarywang.wxpay.config.WxPayConfig#initApiV3HttpClient()
该方法用于初始化微信支付V3接口的HTTP客户端，主要功能包括：

1. 校验并加载APIv3密钥；
2. 从p12或PEM证书中提取私钥和证书信息； p12ToPem()
3. 构造支持自动签名验签的HttpClient；
4. 支持设置HTTP代理；
5. 提供自定义HttpClientBuilder的能力。


com.github.binarywang.wxpay.config.WxPayConfig#p12ToPem
该方法用于解析PKCS#12格式的证书文件（.p12），提取其中的私钥和X509证书。
首先校验商户ID及证书路径或内容是否存在，
然后加载证书文件并使用商户ID作为密码解密，
最后获取证书中的私钥和证书对象，返回一个包含这两个对象的数组。
若过程中出现异常，则记录错误日志并返回null。







# 直接对 p12 文件进行 base64 编码
openssl base64 -in certificate.p12 -out certificate.p12.base64

# 或者使用标准 base64 命令（如果系统支持）
base64 -i certificate.p12 -o certificate.p12.base64







微信小程序授权登录参考文档
[【微信官方】-小程序登录](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)
[【WxJava】-0_小程序开发文档]https://github.com/binarywang/WxJava/wiki/0_%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3


微信 H5 授权登录参考文档
[【微信官方】-网页开发/网页授权](https://developers.weixin.qq.com/doc/service/guide/h5/auth.html)
[【WxJava】-MP_OAuth2网页授权](https://github.com/binarywang/WxJava/wiki/MP_OAuth2%E7%BD%91%E9%A1%B5%E6%8E%88%E6%9D%83)


[【微信官方】-服务商支付](https://pay.weixin.qq.com/doc/v3/partner/4012069852)


