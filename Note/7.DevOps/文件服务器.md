# Nginx 文件服务器配置
## 基础配置
```nginx
http {
    charset utf-8;
    server {
        listen       80;
        # server_name  yourdomain.com; # 替换为你的域名或IP地址

        location /file2hive/ {
            alias /data0/file2hive/test/;
            autoindex on;

            # 允许上传文件
            client_max_body_size 100M; # 设置最大上传文件大小

            # 如果请求的资源不存在，尝试将请求转发到索引文件
            index index.html index.htm;

            # 配置权限，确保只有授权的用户可以上传文件
            # auth_basic "Restricted Area";
            # auth_basic_user_file /etc/nginx/.htpasswd; # 需要预先创建.htpasswd文件

            # 限制请求速率，可选
            # limit_rate 100k;

            # 如果需要，可以在这里添加更多的location指令
        }
    }

    server {
        listen       80;
        # server_name  yourdomain.com;

        location /upload/ { # 更改路径以适应你的需求
            root /data0/file2hive/test/;
            autoindex on;

            client_max_body_size 100M; # 设置最大上传文件大小

            # 用于处理POST请求，即文件上传
            if ($request_method = POST) {
                rewrite ^(.*)$ /upload_form.html break;
            }

            # 文件上传表单页面
            root /opt/nginx-1.18.0/conf/;
            try_files $uri $uri/ /upload_form.html;
        }
    }
}
```

## 访问地址
- 文件访问: `http://192.168.100.39/file2hive/`
- 上传接口: `http://192.168.100.39/upload/`

## 文件上传测试
```bash
# 使用curl上传
curl -X POST --upload-file C:\\Users\\osmondy\\Documents\\会刊pdf校验\\2023-07-05_200家_2023上海国际快递物流博览会-数据质量校验.xlsx  http://192.168.100.39:9090/exhibitor/

# 使用wget上传
wget --upload-file=C:\\Users\\osmondy\\Documents\\会刊pdf校验\\2023-07-05_200家_2023上海国际快递物流博览会-数据质量校验.xlsx http://192.168.100.39/file2hive/2023-07-05_200家_2023上海国际快递物流博览会-数据质量校验.xlsx
```

## Docker部署方案
```bash
# Nginx文件服务器
docker run -v /data0/file2hive/test:/web/www  -d -p 9090:8080 chishin/fileserver:latest

# Nginx WebDAV
docker run -v /data0/file2hive/test:/usr/local/nginx/html  -d -p 9091:80 lutixiaya/nwebdav:latest

# Plik文件服务器
docker run  -d  \
--name plik \
-p 8566:8080  \
-v /data0/file2hive/test:/home/plik/server/files  \
rootgg/plik
```


## 安全配置
### 基本身份验证
```bash
# 生成.htpasswd文件
htpasswd -c /etc/nginx/.htpasswd username

# 示例配置
location /file2hive/ {
    auth_basic "Restricted Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
}
```

### 防火墙配置
```bash
# 允许HTTP/HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# 允许FTP
ufw allow 20:21/tcp
ufw allow 21100:21110/tcp
```

### HTTPS配置
```nginx
server {
    listen 443 ssl;
    server_name yourdomain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/privkey.pem;
    
    location /file2hive/ {
        alias /data0/file2hive/test/;
        autoindex on;
        auth_basic "Restricted Area";
        auth_basic_user_file /etc/nginx/.htpasswd;
    }
}
```

## 文件存储路径规划
```
/data0/file2hive/
├── test/           # 测试环境
├── production/     # 生产环境
└── backup/         # 备份目录
```

## vsftpd配置
```bash
docker run \
-d \
-v /root/vsftpd:/home/vsftpd \
-p 20:20 \
-p 21:21 \
-p 21100-21110:21100-21110 \
-e PASV_ADDRESS=192.168.100.39 \
-e PASV_MIN_PORT=21100 \
-e PASV_MAX_PORT=21110 \
--name vsftpd \
--restart=always \
fauria/vsftpd
```


### 用户管理
```bash
# 创建用户目录
mkdir -p /home/vsftpd/{admin,yangjinhua,yuhao}

# 容器内部生成密码
htpasswd /etc/vsftpd/virtual_users.txt admin
htpasswd /etc/vsftpd/virtual_users.txt yangjinhua
htpasswd /etc/vsftpd/virtual_users.txt yuhao
```

### 登录方式
- 浏览器访问: `ftp://yangjinhua:666@192.168.100.39:21`
- 命令行登录: `ftp 192.168.100.39`

### 常用命令
```bash
# 查看文件列表
dir

# 上传文件
put config.py 

# 下载文件
get config.py
```
