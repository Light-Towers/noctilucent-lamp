# 证书与密钥笔记

本文档总结常见证书与密钥文件格式、命名（如 `.p12`、`cert.pem`、`key.pem`）的含义、证书链、序列号（serial）、指纹（fingerprint）、CSR（证书签名请求），以及常用的 OpenSSL 命令（在 Windows `cmd.exe` 场景下的示例）。

## 1. 常见文件与格式

- `.p12` / `.pfx`（PKCS#12）
  - 二进制格式（通常是 DER 编码的容器），用于把私钥与证书（以及可选的中间证书/根证书）打包在一起。
  - 通常受密码保护（导出/导入时需要密码）。
  - 常用于 Windows、Java（keystore/truststore）、浏览器导入/导出。

- `cert.pem` / `certificate.pem`（PEM 编码的证书）
  - 文本格式（Base64 编码），以 "-----BEGIN CERTIFICATE-----" / "-----END CERTIFICATE-----" 包围。
  - 仅包含证书公钥与元信息，不包含私钥。

- `key.pem` / `privkey.pem`（PEM 编码的私钥）
  - 文本格式（Base64 编码），以 "-----BEGIN PRIVATE KEY-----" 或 "-----BEGIN RSA PRIVATE KEY-----" 包围。
  - 可能使用密码（加密私钥），这时文件头会有加密说明；也可能是未加密私钥（部署时需谨慎）。

- DER
  - 二进制编码格式。证书可以以 DER 或 PEM 存储（PEM 是 DER 的 Base64 包装并加上头尾）。

- PKCS#1 / PKCS#8 / PKCS#12
  - PKCS#1：早期 RSA 私钥格式（常见头为 "BEGIN RSA PRIVATE KEY"）。
  - PKCS#8：更通用的私钥格式（"BEGIN PRIVATE KEY" 或加密时 "BEGIN ENCRYPTED PRIVATE KEY"）。
  - PKCS#12：容器格式（.p12/.pfx），可以包含私钥与证书链。

## 2. 证书相关概念

- 证书序列号（Serial Number）
  - 证书颁发机构（CA）为每张证书分配的唯一编号。可以用来查找或撤销证书。
  - OpenSSL 查看示例：`openssl x509 -in cert.pem -noout -serial`

- 指纹（Fingerprint）
  - 证书的哈希值（常见为 SHA1、SHA256），用于快速校验证书完整性与唯一性。
  - OpenSSL 查看示例：`openssl x509 -in cert.pem -noout -fingerprint -sha256`

- 证书链（Certificate Chain）
  - 从服务器证书到根证书的一系列证书（可能包含一个或多个中间 CA）。客户端需要信任链上的根证书，或由操作系统/应用内置。

- CSR（证书签名请求, Certificate Signing Request）
  - 在申请证书时生成的请求，包含公钥与主体信息（CN、O、OU 等）。CA 使用 CSR 签发正式证书。
  - 生成示例：`openssl req -new -key key.pem -out request.csr`

## 3. 常用 OpenSSL 命令（Windows cmd 示例）

注意：在 Windows 上使用 OpenSSL，命令行基本与类 Unix 相同，但请确保已正确安装并将 `openssl.exe` 加入 PATH。

- 查看证书内容（PEM）
  - openssl x509 -in cert.pem -text -noout

- 查看证书序列号
  - openssl x509 -in cert.pem -noout -serial

- 查看证书指纹（SHA256）
  - openssl x509 -in cert.pem -noout -fingerprint -sha256

- 将 `.p12` 转为 PEM（输出证书和私钥）
  - 导出证书（PEM）:
    - openssl pkcs12 -in certificate.p12 -clcerts -nokeys -out cert.pem
  - 导出私钥（PEM，可能会要求输入 p12 密码，并且私钥如果受保护会要求设置一个新密码）:
    - openssl pkcs12 -in certificate.p12 -nocerts -out key_encrypted.pem
    - 如果需要去除私钥密码（生成未加密的 key.pem，注意安全风险）:
      - openssl rsa -in key_encrypted.pem -out key.pem

- 将 PEM 私钥（PKCS#1 / PKCS#8）格式互转
  - PKCS#1 (RSA) -> PKCS#8 (unencrypted): openssl pkcs8 -topk8 -inform PEM -outform PEM -in rsa_key.pem -out key_pkcs8.pem -nocrypt

- 将 PEM 证书转换为 DER（用于某些设备）
  - openssl x509 -outform der -in cert.pem -out cert.der

- 将 DER 证书转换为 PEM
  - openssl x509 -inform der -in cert.der -out cert.pem

- 查看 .p12 中内容（列出证书与私钥摘要）
  - openssl pkcs12 -in certificate.p12 -nodes -info

- 直接对 p12 文件进行 base64 编码（适合存储在文本配置中）
  - openssl base64 -in certificate.p12 -out certificate.p12.base64

### Linux / macOS 下的常用 OpenSSL 命令补充

下面是一些在 Linux 或 macOS 环境下常用且实用的 openssl 命令，包含生成 CSR、验证证书与私钥是否匹配、合并证书链、查看公钥等：

- 生成新的 RSA 私钥（2048 位）并生成 CSR（交互式填写信息）
  - openssl req -newkey rsa:2048 -nodes -keyout key.pem -out request.csr

- 生成带口令保护的私钥
  - openssl genrsa -aes256 -out key_protected.pem 2048

- 从私钥生成公钥（PEM 格式）
  - openssl rsa -in key.pem -pubout -out public.pem

- 验证证书与私钥是否匹配（计算 modulus 并比较）
  - 私钥模数：openssl rsa -noout -modulus -in key.pem | openssl md5
  - 证书模数：openssl x509 -noout -modulus -in cert.pem | openssl md5
  - 两者 md5 值相同则匹配（也可直接比较明文 modulus）

- 合并证书链（将服务器证书放在第一位，后面依次为中间证书）
  - cat server_cert.pem intermediate.pem root.pem > fullchain.pem

- 验证证书链（使用系统根或指定 CA）
  - 使用系统根（若 openssl 配置了系统 CA）：openssl verify -CAfile /etc/ssl/certs/ca-bundle.crt fullchain.pem
  - 指定单个 CA：openssl verify -CAfile ca.pem cert.pem

- 查看证书有效期（开始/结束时间）
  - openssl x509 -in cert.pem -noout -dates

- 导出 PKCS#12（将 cert + key 打包为 p12，设置导出密码）
  - openssl pkcs12 -export -out bundle.p12 -inkey key.pem -in cert.pem -certfile intermediate.pem

- 检查私钥是否为加密格式（查看头部或尝试读取）
  - openssl pkey -in key.pem -noout -text (如果报错提示需要密码则为加密私钥)

- 使用 OpenSSL 连接到 HTTPS 服务并查看证书（调试 TLS）
  - openssl s_client -connect example.com:443 -showcerts

- 从证书中提取公钥并输出为 DER 格式
  - openssl x509 -in cert.pem -pubkey -noout > pubkey.pem
  - openssl rsa -pubin -in pubkey.pem -outform der -out pubkey.der

- 从 base64 文本恢复 p12（如果你有 base64 编码的 p12 文件）
  - openssl base64 -d -in certificate.p12.base64 -out certificate.p12

这些命令均可直接在 Linux/macOS 的终端中使用（bash、zsh 等）。在脚本中自动化时，请注意对密码或敏感值的安全处理，避免在命令行历史中泄露。

## 4. 微信支付 V3 相关证书说明与实践建议

- 常见文件
  - apiclient_cert.pem / apiclient_key.pem：商户 API 证书和私钥（用于商户端签名）。
  - pub_key.pem / wechatpay_public.pem：微信支付平台公钥（用于验证微信响应签名或在验签时使用）。

- 获取证书序列号（certSerialNo）
  - openssl x509 -in apiclient_cert.pem -noout -serial
  - 注意：微信的 certSerialNo 有特定格式（大写十六进制），在代码或配置中需保持一致。

- 签名与验签
  - V3 使用的是 SHA256withRSA（即 RSA 签名 + SHA256 摘要），签名需要私钥，验签使用微信提供的公钥或平台证书。

- 存储与权限
  - 私钥文件（`key.pem` / `apiclient_key.pem`）必须严格受限访问（例如 Linux 下 600 权限）。
  - 不要在版本控制中提交私钥或包含私钥的 `.p12`。
  - 在容器或云环境中 prefer 使用安全的 Secret 管理（AWS Secrets Manager、Azure Key Vault、Kubernetes Secrets 等）。

- 轮换与更新
  - 定期更换（轮换）私钥/证书，尤其是在密钥泄露或人员变动后。

- 证书来源
  - 微信支付文档说明如何获取商户 API 证书、平台公钥等（参见微信商户平台）。

## 5. 示例工作流：从 p12 到 微信所需 PEM 文件

1. 如果你只有 `apiclient_cert.p12`，先导出证书与私钥：

   openssl pkcs12 -in apiclient_cert.p12 -clcerts -nokeys -out apiclient_cert.pem
   openssl pkcs12 -in apiclient_cert.p12 -nocerts -out apiclient_key_encrypted.pem

2. 去除私钥口令（如果需要自动化部署，请先确保安全性）：

   openssl rsa -in apiclient_key_encrypted.pem -out apiclient_key.pem

3. 查看序列号（用于 `certSerialNo` 配置）：

   openssl x509 -in apiclient_cert.pem -noout -serial

4. （可选）把证书转换为 Base64 文本以便存入数据库或配置：

   openssl base64 -in apiclient_cert.p12 -out apiclient_cert.p12.base64

## 6. 常见问题与排查小贴士

- 验签失败
  - 检查是否使用正确的公钥（微信公钥 vs 平台证书）、签名算法是否为 SHA256withRSA、时间戳与 nonce 是否正确。

- 文件格式错误
  - 检查文件是否为 PEM（文本）或 DER（二进制）。如果看到非 ASCII 字符且没有 "BEGIN" 标签，可能是 DER。

- 私钥密码问题
  - 如果私钥是加密的，在程序中使用时需要解密或提供对应的解密方式。尽量在部署阶段转换为受控的非交互式秘钥文件，或使用安全代理/agent。

## 7. 安全建议小结

1. 私钥永不上传到公共仓库。
2. 使用最小访问权限保护私钥文件（文件权限、密钥管理服务）。
3. 如果需要将私钥或证书放入配置中，使用加密或专门的秘钥管理系统。
4. 对生产证书实施监控：到期告警、撤销检查、定期轮换。

---

如需要，我可以：
- 把示例命令改为针对你当前环境（Windows 下 OpenSSL 安装路径），
- 或者把证书导出、序列号提取的实际命令在你的文件上跑一遍（需要你提供 p12 文件路径或允许我在工作区读取），
- 或者把该笔记翻译为更简洁的速查表。
