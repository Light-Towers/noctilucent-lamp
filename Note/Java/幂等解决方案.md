## **什么是幂等性**

- 所谓幂等性通俗的将就是一次请求和多次请求同一个资源产生相同的副作用。用数学语言表达就是`f(x)=f(f(x))`。

  > ```java
  > 幂等（idempotent、idempotence）是一个数学与计算机学概念，常见于抽象代数中。
  > 在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。例如，“setTrue()”函数就是一个幂等函数,无论多次执行，其结果都是一样的，更复杂的操作幂等保证是利用唯一交易号(流水号)实现.
  > ```

## 为何需要

- ① 用户**重复下订单**：当用户下单时，因为网络问题或者手速过快，导致重复下单。
- ② 消息**重复消费**：当使用 MQ 消息中间件时候，如果消息中间件发生异常出现错误未及时提交消费信息，导致消息被重复消费。
- ③ **抽奖活动(券)**：当用户参加抽奖活动需要消耗抽奖券时，如果出现并发请求导致抽奖券余额更新错误。
- ④ **重复提交表单**：当用户填写表单提交时，可能会因为用户点多次连击提交或者网络波动导致服务端未及时响应，会导致用户重复的提交表单，就出现了同一个表单多次请求。

## 解决方案

### 基于索引

使用唯一主键或者唯一键约束

适用于：插入操作、删除操作

### 版本号

在对应的数据表中多添加一个字段，充当当前数据的版本标识。每次对该表执行更新时，将该版本标识作为一个条件，值为上次待更新数据中的版本标识的值。

```sql
update my_table set price=50, version=version+1 where id=3 and version=5;
```

适用于：更新操作

### **TOKEN机制**

服务端需要生成一个**全局唯一的 id**，（例如：**snowflake 雪花算法**，**美团 Leaf 算法**，**滴滴 TinyID 算法**，**百度 Uidgenerator 算法**，**uuid**，**redis** 等）。

1. 客户端先向服务端申请一个全局ID（Token）存储本地，服务端存储全局ID（Token） 值(redis,文件，memcache 都可)
2. 每次发送请求时在 Headers 中带上 token 令牌
3. 服务端验证 Token 是否存在，存在则删除 token，执行后续业务逻辑；不存在则响应客户端“重复提交”提示语

适用于：插入操作、更新操作、删除操作

### 自己的方法

与 Token 类似

1. 基于入参生成 MD5(其它方法也行，只要能确定生成结果的一致性) 作为Key，存入redis。
2. 多次请求判断key是否存在，存在即返回 “请勿重复提交”
3. 逻辑执行完毕（或异常），删除key

